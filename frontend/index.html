<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–ä»»åŠ¡æ—¥å¿—çœ‹æ¿</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f6f8fa;
            color: #24292f;
            transition: background 0.3s;
        }

        .header-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #d0d7de;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-radius: 6px;
            color: #57606a;
        }

        .tab-btn.active {
            background: #0969da;
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #eaeff2;
        }

        .card {
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .success {
            background: #dafbe1;
            color: #1a7f37;
            border: 1px solid rgba(26, 127, 55, 0.2);
        }

        .failure {
            background: #ffebe9;
            color: #cf222e;
            border: 1px solid rgba(207, 34, 46, 0.2);
        }

        .unknown {
            background: #f6f8fa;
            color: #57606a;
            border: 1px solid rgba(87, 96, 106, 0.2);
        }

        pre {
            background: #2d333b;
            color: #adbac7;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            margin: 0;
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
        }

        .time {
            color: #57606a;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .run-id {
            font-size: 12px;
            color: #8c959f;
            font-family: monospace;
        }

        /* Admin UI */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-group textarea {
            height: 300px;
            font-family: monospace;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid rgba(27, 31, 35, 0.15);
            transition: 0.2s;
        }

        .btn-primary {
            background: #2da44e;
            color: white;
        }

        .btn-primary:hover {
            background: #2c974b;
        }

        .btn-run {
            background: #0969da;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-run:hover {
            background: #0550ae;
        }

        .btn-save {
            background: #2da44e;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .status-msg {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="header-title">
        <h1>ğŸ¤– è‡ªåŠ¨åŒ–ä»»åŠ¡çœ‹æ¿</h1>
        <p style="color: #57606a;">åŸºäº GitHub Actions & Pages çš„æ— æœåŠ¡å™¨ç®¡ç†å°</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('logs')">ğŸ“‹ æ—¥å¿—çŠ¶æ€</button>
        <button class="tab-btn" onclick="switchTab('admin')">âš™ï¸ ä»»åŠ¡ç®¡ç†</button>
    </div>

    <!-- Logs Section -->
    <div id="logs-section" class="admin-section active">
        <div id="log-container">
            <div class="loading" style="text-align: center; padding: 40px;">æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...</div>
        </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="admin-section">
        <div class="card">
            <h3>ğŸ”‘ èº«ä»½éªŒè¯</h3>
            <div class="form-group">
                <label>GitHub Personal Access Token (PAT)</label>
                <input type="password" id="github-token" placeholder="è¾“å…¥ ghp_ å¼€å¤´çš„ä»¤ç‰Œ...">
                <p style="font-size: 12px; color: #57606a;">ä»¤ç‰Œä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ° localStorageï¼Œç”¨äºè°ƒç”¨ GitHub APIã€‚</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-run" onclick="triggerWorkflow()">ğŸš€ ç«‹å³è¿è¡Œæ‰€æœ‰ä»»åŠ¡</button>
                <button class="btn" style="background: #f6f8fa; color: #24292f;" onclick="loadWorkflows()">ğŸ”„
                    åŠ è½½å½“å‰è„šæœ¬</button>
            </div>
            <div id="trigger-msg" class="status-msg"></div>
        </div>

        <div class="card">
            <h3>ğŸ“ è„šæœ¬ç¼–è¾‘ (workflows.json)</h3>
            <div class="form-group">
                <textarea id="workflow-editor" placeholder="æ­£åœ¨åŠ è½½ workflows.json..."></textarea>
            </div>
            <button class="btn btn-save" id="save-btn" onclick="saveWorkflows()">ğŸ’¾ ä¿å­˜å¹¶éƒ¨ç½²åˆ° GitHub</button>
            <div id="save-msg" class="status-msg"></div>
        </div>
    </div>

    <script>
        const REPO = 'luoluoluo22/gh-action-log-monitor';

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-section').classList.add('active');

            if (tab === 'logs') loadLogs();
            if (tab === 'admin') {
                const savedToken = localStorage.getItem('gh_token');
                if (savedToken) document.getElementById('github-token').value = savedToken;
                loadWorkflows();
            }
        }

        function loadLogs() {
            fetch('data.json?t=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('log-container');
                    container.innerHTML = data.length ? '' : '<div style="text-align:center;padding:40px;color:#57606a;">æš‚æ— è®°å½•</div>';
                    data.forEach(item => {
                        const statusClass = item.status === 'success' ? 'success' : (item.status === 'unknown' ? 'unknown' : 'failure');
                        container.innerHTML += `
                            <div class="card">
                                <div class="card-header">
                                    <div><span class="badge ${statusClass}">${item.status}</span> <span class="run-id">ID: ${item.id}</span></div>
                                    <span class="time">ğŸ•’ ${item.timestamp}</span>
                                </div>
                                <pre>${item.logs}</pre>
                            </div>`;
                    });
                }).catch(err => {
                    document.getElementById('log-container').innerHTML = '<div class="card" style="color:#cf222e;">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
                });
        }

        async function loadWorkflows() {
            const editor = document.getElementById('workflow-editor');
            editor.value = 'æ­£åœ¨ä» GitHub è·å–æœ€æ–°ç‰ˆæœ¬...';
            try {
                // ç›´æ¥ä» GitHub API è·å–ï¼Œé¿å¼€ç¼“å­˜
                const resp = await fetch(`https://api.github.com/repos/${REPO}/contents/workflows.json?t=` + Date.now());
                const data = await resp.json();
                const content = atob(data.content); // Base64 decode
                window.workflowSHA = data.sha; // è®°å½• SHA ç”¨äºæ›´æ–°
                editor.value = content;
                // åŒæ—¶ç¾åŒ–ä¸€ä¸‹
                try {
                    editor.value = JSON.stringify(JSON.parse(content), null, 4);
                } catch (e) { }
            } catch (err) {
                editor.value = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä»“åº“æƒé™';
            }
        }

        async function saveWorkflows() {
            const token = document.getElementById('github-token').value;
            const content = document.getElementById('workflow-editor').value;
            const msg = document.getElementById('save-msg');
            const btn = document.getElementById('save-btn');

            if (!token) return alert('è¯·å…ˆè¾“å…¥ GitHub Token!');
            localStorage.setItem('gh_token', token);

            try {
                btn.disabled = true;
                btn.innerText = 'æ­£åœ¨ä¿å­˜...';

                const resp = await fetch(`https://api.github.com/repos/${REPO}/contents/workflows.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update workflows via Admin Console",
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: window.workflowSHA
                    })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    window.workflowSHA = data.content.sha;
                    msg.style.display = 'block';
                    msg.style.background = '#dafbe1';
                    msg.innerText = 'âœ… ä¿å­˜æˆåŠŸï¼æ­£åœ¨é‡æ–°éƒ¨ç½²ï¼Œé¢„è®¡ 30s å†…ç”Ÿæ•ˆã€‚';
                } else {
                    const error = await resp.json();
                    throw new Error(error.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (err) {
                msg.style.display = 'block';
                msg.style.background = '#ffebe9';
                msg.innerText = 'âŒ é”™è¯¯: ' + err.message;
            } finally {
                btn.disabled = false;
                btn.innerText = 'ğŸ’¾ ä¿å­˜å¹¶éƒ¨ç½²åˆ° GitHub';
            }
        }

        async function triggerWorkflow() {
            const token = document.getElementById('github-token').value;
            const msg = document.getElementById('trigger-msg');
            if (!token) return alert('è¯·å…ˆè¾“å…¥ GitHub Token!');
            localStorage.setItem('gh_token', token);

            try {
                const resp = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/main.yml/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: 'main' })
                });

                if (resp.status === 204) { // Dispatch success returns 204
                    msg.style.display = 'block';
                    msg.style.background = '#dafbe1';
                    msg.innerText = 'ğŸš€ è¿è¡Œè¯·æ±‚å·²å‘é€ï¼è¯·ç¨ååˆ·æ–°æ—¥å¿—é¡µé¢æŸ¥çœ‹ç»“æœã€‚';
                } else {
                    const error = await resp.json();
                    throw new Error(error.message);
                }
            } catch (err) {
                msg.style.display = 'block';
                msg.style.background = '#ffebe9';
                msg.innerText = 'âŒ è§¦å‘å¤±è´¥: ' + err.message;
            }
        }

        // Init
        loadLogs();
    </script>
</body>

</html>